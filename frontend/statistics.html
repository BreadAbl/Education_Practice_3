<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="dashboard.html">üîß –¢–µ—Ö–Ω–∏–∫–∞</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">–ó–∞—è–≤–∫–∏</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="statistics.html">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
                    </li>
                    <li class="nav-item" id="usersLink" style="display:none;">
                        <a class="nav-link" href="users.html">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <span class="navbar-text text-white me-3">
                            üë§ <span id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </span>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-outline-light btn-sm" onclick="logout()">–í—ã—Ö–æ–¥</button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2 class="mb-4">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>

        <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center bg-primary text-white">
                    <div class="card-body">
                        <h5>–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</h5>
                        <p class="display-4" id="statTotalRequests">-</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-success text-white">
                    <div class="card-body">
                        <h5>–ó–∞–≤–µ—Ä—à–µ–Ω–æ</h5>
                        <p class="display-4" id="statCompleted">-</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-warning text-dark">
                    <div class="card-body">
                        <h5>–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è</h5>
                        <p class="display-4" id="statAvgTime">-</p>
                        <small>–¥–Ω–µ–π</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-info text-white">
                    <div class="card-body">
                        <h5>–ú–∞—Å—Ç–µ—Ä–æ–≤</h5>
                        <p class="display-4" id="statMasters">-</p>
                    </div>
                </div>
            </div>
        </div>


        <!-- QR-–∫–æ–¥ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ -->
        <div class="card">
            <div class="card-header">
                <h5>üì± QR-–∫–æ–¥ —Ñ–æ—Ä–º—ã –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏</h5>
            </div>
            <div class="card-body text-center">
                <img id="qrCode" src="" alt="QR-–∫–æ–¥" style="max-width: 300px;">
                <p class="mt-3">
                    <a href="#" id="feedbackLink" target="_blank" class="btn btn-primary">
                        –û—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
                    </a>
                </p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>

    <script>
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        document.addEventListener('DOMContentLoaded', async () => {
            await loadStatistics();
            loadQRCode();
        });

        async function loadStatistics() {
            try {
                const response = await api.get('/statistics/');
                const data = await response.json();

                if (!response.ok) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞:', data);
                    return;
                }

                console.log('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', data);

                // ‚úÖ –ü–æ–¥ –Ω–æ–≤—ã–π backend: —á–∏—Å–ª–∞ –ª–µ–∂–∞—Ç –ø—Ä—è–º–æ –≤ –ø–æ–ª—è—Ö
                document.getElementById('statTotalRequests').textContent = data.total_requests || 0;
                document.getElementById('statCompleted').textContent = data.completed_requests || 0;
                document.getElementById('statAvgTime').textContent = data.avg_completion_days || 0;
                document.getElementById('statMasters').textContent = data.masters_count || 0;

                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º
                displayProjectStats(data.project_statistics || []);

                // –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –º–∞—Å—Ç–µ—Ä–æ–≤
                displayMasterWorkload(data.master_workload || []);

            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        function displayProjectStats(projects) {
            const tbody = document.getElementById('projectStats');
            if (!projects || projects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
                return;
            }

            tbody.innerHTML = projects.map(p => {
                const total = p.total_requests || 0;
                const completed = p.completed_requests || 0;
                const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;

                return `
                    <tr>
                        <td><strong>${p.project ?? '–ù–µ —É–∫–∞–∑–∞–Ω'}</strong></td>
                        <td>${total}</td>
                        <td>${completed}</td>
                        <td>
                            <div class="progress">
                                <div class="progress-bar bg-success" style="width: ${percentage}%">
                                    ${percentage}%
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function displayMasterWorkload(masters) {
            const tbody = document.getElementById('masterWorkload');
            if (!masters || masters.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
                return;
            }

            tbody.innerHTML = masters.map(m => `
                <tr>
                    <td>${m.master_name ?? '-'}</td>
                    <td><span class="badge bg-warning">${m.active_requests ?? 0}</span></td>
                    <td><span class="badge bg-success">${m.completed_requests ?? 0}</span></td>
                    <td><strong>${m.total_requests ?? 0}</strong></td>
                </tr>
            `).join('');
        }

        function loadQRCode() {
            const qrUrl = `${API_URL.replace('/api', '')}/qr/feedback`;
            document.getElementById('qrCode').src = qrUrl;

            // –°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ä–º—É (–∏–∑ config.py)
            document.getElementById('feedbackLink').href =
                'https://docs.google.com/forms/d/e/1FAIpQLSdhZcExx6LSIXxk0ub55mSu-WIh23WYdGG9HY5EZhLDo7P8eA/viewform';
        }
    </script>
</body>
</html>